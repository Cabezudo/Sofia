<!DOCTYPE html>
<html profiles="all">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu digital</title>
    <link rel="stylesheet" type="text/css" href="index.css">
    <script src="variables.js"></script>
    <script src="index.js"></script>
    <script lib="core/0.1.0"></script>
    <script lib="image/0.1.0"></script>
    <script lib="simpleOverlay/0.1.0"></script>
    <script lib="linkTo/0.1.0"></script>
    <script lib="roundButton/0.1.0"></script>
    <script>
      {
        let
                overlay, info, categoriesContainerElement, categoryElementContainer = [], elementContainerSelected = 0,
                dishGroupsContainerElement, dishGroupsElement = [];
        // TODO create a library with fontFitter
        const fontFitter = (element, fontSize) => {
          const fitFontOnElement = (element, fontSize) => {
            const running = element.getAttribute('running');
            if (running === 'true') {
              return;
            }
            element.setAttribute('running', true);
            const child = element.firstChild;
            child.style.fontSize = `${fontSize}px`;
            const color = child.style.color;
            child.style.color = 'transparent';
            const checkFont = () => {
              if (element.clientHeight < child.scrollHeight && fontSize > 2) {
                fontSize--;
                child.style.fontSize = `${fontSize}px`;
                setTimeout(checkFont, 50);
              } else {
                element.setAttribute('running', false);
                child.style.color = color;
              }
            };
            checkFont();
          };
          Core.addOnResizeFunction(() => {
            fitFontOnElement(element, fontSize);
          });
          window.addEventListener('show', e => {
            fitFontOnElement(element, fontSize);
          });
          fitFontOnElement(element, fontSize);
        };
        const showDish = (event, dish) => {
          let quantity = 1;
          let total;
          const setValues = () => {
            total = quantity * dish.price.cost;
            document.getElementById('quantityOnButton').innerHTML = quantity;
            document.getElementById('totalCost').innerHTML = `${dish.price.currency} ${total}`;
          };
          let description = dish.description;
          if (description === null) {
            description = '';
          }
          const content = `
            <div id="overlayContainer">
              <div id="overlayContent">
                <div id="dishContainer">
                  <div id="dishImage">
                    <div id="closeButton" class="closeButton"></div>
                  </div>
                  <div id="dishInfo">
                    <div id="dishTitle">${dish.name}</div>
                    <div id="dishDescription">${description}</div>
                    <div id="options"></div>
                  </div>
                  <div id="controlPanelContainer">
                    <div id="controlPanel">
                      <div id="buttonContainer">
                        <div id="removeButton"></div>
                        <div id="totalCost"></div>
                        <div id="addButton"></div>
                      </div>
                      <div id="statusContainer">
                        <div id="status">Agregar <span id="quantityOnButton"></span> a la orden</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>`;
          overlay.setContent(content);
          // TODO ocultar con ESC
          crossRoundButton({
            id: 'closeButton',
            onClick: () => {
              overlay.hide();
            }
          });
          const removeButton = removeRoundButton({
            id: 'removeButton',
            onClick: () => {
              if (quantity > 1) {
                quantity--;
                setValues();
              }
              removeButton.enable();
            }
          });
          const addButton = addRoundButton({
            id: 'addButton',
            onClick: () => {
              if (quantity < 20) {
                quantity++;
                setValues();
              }
              addButton.enable();
            }
          });
          overlay.show();
          image({id: 'dishImage', src: `/images/${dish.imageName}?resize(height=400)`});
          setValues();
        };
        const setCategorySelected = () => {
          for (let i = 0; i < categoryElementContainer.length; i++) {
            // TODO Si la categoría está seleccionada no mostrar la manito
            if (elementContainerSelected === i) {
              categoryElementContainer[i].className = 'category selected';
              Core.show(dishGroupsElement[i]);
            } else {
              categoryElementContainer[i].className = 'category';
              Core.hide(dishGroupsElement[i]);
            }
          }
        };

        const createMenu = detail => {
          const menu = detail.menu;
          const categoriesHours = detail.hours.categories;
          // TODO Si la categoria es una sola no mostrar
          for (let i = 0; i < menu.length; i++) {
            const category = menu[i];
            const categoryName = category.name;
            const categoryHours = categoriesHours[categoryName];
            categoryElementContainer[i] = document.createElement('DIV');
            categoryElementContainer[i].onclick = () => {
              elementContainerSelected = i;
              setCategorySelected();
            };
            let categoryHoursText;
            if (categoryHours === null || categoriesHours.length === 0) {
              categoryHoursText = `No se sirve hoy`;
            } else {
              categoryHoursText = '';
              categoryHours.forEach(item => {
                categoryHoursText += `<div>${item.start} hs - ${item.end} hs</div>`;
              });
            }
            categoryElementContainer[i].innerHTML = `<div class="categoryName">${categoryName}</div><div class="categoryTime">${categoryHoursText}</div>`;
            categoriesContainerElement.appendChild(categoryElementContainer[i]);
            const categorySpace = document.createElement('DIV');
            categorySpace.className = 'categorySpace';
            categoriesContainerElement.appendChild(categorySpace);
            dishGroupsElement[i] = document.createElement('DIV');
            dishGroupsElement[i].className = 'dishGroups';
            dishGroupsContainerElement.appendChild(dishGroupsElement[i]);
            const dishGroups = category.dishGroups;
            dishGroups.forEach(dishGroup => {
              const dishGroupElement = document.createElement('DIV');
              dishGroupElement.innerHTML = `<div class="dishGroupTitle">${dishGroup.name}</div>`;
              dishGroupsElement[i].appendChild(dishGroupElement);
              const dishesContainerElement = document.createElement('DIV');
              dishesContainerElement.className = 'dishes';
              dishGroupElement.appendChild(dishesContainerElement);
              const dishes = dishGroup.dishes;
              dishes.forEach(dish => {
                const dishElement = document.createElement('DIV');
                dishElement.className = 'dish';
                dishesContainerElement.appendChild(dishElement);
                const dishDataElement = document.createElement('DIV');
                dishDataElement.className = 'dishData';
                dishElement.appendChild(dishDataElement);
                const dishDataNameElement = document.createElement('DIV');
                dishDataNameElement.className = 'dishName';
                dishDataNameElement.innerHTML = `<div>${dish.name}</div>`;
                dishDataElement.appendChild(dishDataNameElement);
                fontFitter(dishDataNameElement, 16);
                const dishDataDescriptionContainerElement = document.createElement('DIV');
                dishDataDescriptionContainerElement.className = 'dishDescriptionContainer';
                dishDataElement.appendChild(dishDataDescriptionContainerElement);
                const dishDataDescriptionElement = document.createElement('DIV');
                dishDataDescriptionElement.innerHTML = `${dish.description === null ? '' : dish.description}`;
                dishDataDescriptionElement.className = 'dishDescription';
                dishDataDescriptionContainerElement.appendChild(dishDataDescriptionElement);
                const dishDataPriceNameElement = document.createElement('DIV');
                dishDataPriceNameElement.className = 'dishPrice';
                dishDataPriceNameElement.innerHTML = `${dish.price.currency}${dish.price.cost}`;
                dishDataElement.appendChild(dishDataPriceNameElement);
                if (dish.imageName !== null) {
                  const dishImageElement = document.createElement('DIV');
                  dishImageElement.className = 'dishImage';
                  dishElement.appendChild(dishImageElement);
                  image({element: dishImageElement, src: `/images/${dish.imageName}?resize(height=180)`});
                }
                dishElement.addEventListener("click", e => {
                  showDish(e, dish);
                });
                fontFitter(dishDataDescriptionContainerElement, 16);
              });
            });
          }
          setCategorySelected();
        };
        const createGUI = () => {
          info = document.getElementById('info');
          info.addEventListener('response', event => {
            const detail = event.detail;
            const businessHours = detail.hours.businessHours;
            const restaurant = detail.restaurant;
            const setData = (id, html) => {
              document.getElementById(id).innerHTML = html;
            };
            const isOpen = detail.hours.isOpen;
            let restaurantImage;
            if (isOpen) {
              restaurantImage = restaurant.imageName;
            } else {
              restaurantImage = `${restaurant.imageName}?brightness(model=hsb,value=30)`;
              let closedText = '';
              let schedule = '';
              if (!businessHours.today.isOpen) {
                if (businessHours.closedUntil !== null) {
                  schedule = `Abre hasta el ${businessHours.closedUntil.name.toLowerCase()} ${businessHours.closedUntil.openAt} hs`;
                }
                if (businessHours.tomorrow.openAt !== null) {
                  schedule = `Abre mañana ${businessHours.tomorrow.name.toLowerCase()} ${businessHours.tomorrow.openAt} hs`;
                }
                if (businessHours.today.openAt !== null) {
                  schedule = `Abre hoy ${businessHours.today.openAt} hs`;
                }
                closedText = `<div class="title">Cerrado</div><div class="schedule">${schedule}</div>`;
                const closed = document.getElementById('closed');
                closed.innerHTML = closedText;
              }
            }
            document.getElementById('image').style.backgroundImage = `url('/images/${restaurantImage}')`;
            setData('name', restaurant.name);
            let typeAndCost = '';
            if (restaurant.type) {
              typeAndCost = `<div>${restaurant.type.name}</div>`;
            }
            switch (restaurant.priceRange) {
              case 1:
                typeAndCost += '&nbsp;&middot;&nbsp;<div class="cost">$</div>';
                break;
              case 2:
                typeAndCost += '&nbsp;&middot;&nbsp;<div class="cost">$$</div>';
                break;
              case 3:
                typeAndCost += '&nbsp;&middot;&nbsp;<div class="cost">$$$</div>';
            }
            setData('typeAndCost', typeAndCost);
            let score = '';
            if (restaurant.score) {
              score = restaurant.score;
              if (restaurant.numberOfVotes) {
                score += ` (${restaurant.numberOfVotes})`;
              }
              setData('score', score);
            }
            setData('name', restaurant.name);
            createMenu(detail);
          });
          categoriesContainerElement = document.getElementById('categories');
          dishGroupsContainerElement = document.getElementById('dishGroups');
          overlay = simpleOverlay({id: 'overlay', scrollElement: document.body});
        };
        const loadData = () => {
          const timeZoneOffset = (new Date()).getTimezoneOffset();
          Core.sendGet(`/api/v1/restaurants/${variables.company.host}/menu?timeZoneOffset=${timeZoneOffset}`, info);
        };
        Core.addOnloadFunction(createGUI);
        Core.addOnloadFunction(loadData);
      }
    </script>
    <style>
      #image {
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        height: 240px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #info {
        background-color: white;
        width: 50%;
        text-align: center;
        font-size: 14px;
        padding: 20px;
      }
      #closed {
        color: white;
        width: 50%;
        text-align: center;
        font-size: 14px;
        padding: 20px;
      }
      #closed > .title{
        font-size: 26px;
        font-weight: 700;
      }
      #closed > .schedule {
        font-size: 16px;
        font-weight: 400;
      }
      #name {
        font-size: 32px;
        font-weight: 700;
      }
      #typeAndCost {
        align-items: center;
        display: flex;
        justify-content: center;
        padding: 10px 0 0 0;
        font-size: 14px;
      }
      .cost {
        display: inline-block;
        font-size: 12px;
      }

      #menu {
        padding: 0 20px;
        max-width: 550px;
        margin: 0 auto;
      }

      #categories {
        display: flex;
        flex-direction: row;
      }
      .category {
        flex-direction: column;
        align-content: flex-start;
        display: flex;
        padding: 20px 0 ;
        border-bottom: 1px solid buttonhighlight;
      }
      .category:hover {
        cursor: pointer;
      }
      .selected {
        border-bottom: 2px solid black;
      }
      .selected:hover {
        cursor: auto;
      }
      .categoryName {
        font-size: 16px;
        font-weight: 500;
        color: rgb(50, 50, 50);
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      .categoryTime {
        color: rgb(100, 100, 100);
        font-size: 12px;
      }
      .categorySpace {
        display: flex;
        width: 20px;
        border-bottom: 1px solid buttonhighlight;
      }
      .categorySpace:last-child {
        flex-grow: 2;
      }
      .dishGroups {

      }
      .dishGroup {

      }
      .dishGroupTitle {
        font-size: 22px;
        font-weight: 800;
        margin: 20px 0;
      }
      #dishes {
      }
      .dish {
        display: flex;
        justify-content: space-between;
        margin: 20px 0;
        border: 1px solid rgb(220, 220, 220);
        max-height: 180px;
        transition: border .1s linear;
      }
      .dish:hover {
        border: 1px solid rgb(50, 50, 50);
        cursor: pointer;
      }
      .dishData {
        display: flex;
        flex-direction: column;
        margin: 20px;
        color: rgb(80, 80, 80);
      }
      .dishName {
        flex-grow: 0;
        margin-bottom: 10px;
        font-size: 18px;
        font-weight: 700;
        overflow: hidden;
      }
      .dishDescriptionContainer {
        flex-grow: 0;
        overflow: hidden;
      }
      .dishDescription {
        font-size:16px;
      }
      .dishPrice {
        font-family: Lato;
        flex-grow: 1;
        align-items: flex-end;
        display: flex;
        font-weight: 400;
        font-size:16px;
        color: rgb(100, 100, 100);
        margin-top: 20px;
      }
      .dishImage {
        flex-basis: 180px;
        flex-grow: 0;
        flex-shrink: 0;
        height: 180px;
        background-position: center;
        background-repeat: no-repeat;
      }

      #overlay {
        display: flex;
        height: 100%;
        width: 100%;
      }
      #overlayContainer {
        height: 100%;
        display: flex;
      }
      #overlayContent {
        height: 100%;
        display: flex;
        overflow: auto;
        margin: auto;
      }
      #dishContainer {
        background-color: white;
        display: flex;
        flex-direction: column;
        min-width: 350px;
        min-height: 100%;
        justify-content: space-between;
        height: fit-content;
      }
      #dishImage {
        width: 100%;
        flex-grow: 0;
        flex-shrink: 0;
        height: 250px;
        background-position: center;
        background-repeat: no-repeat;
        background-size: cover;
        border: 0;
        position: -webkit-sticky;
        position: sticky;
        top: -174px;
      }

      #dishInfo {
        margin: 0 30px;
        flex-grow: 1;
      }
      #dishTitle {
        font-size: 26px;
        font-weight: 600;
        margin: 20px 0;

      }
      #dishDescription{
        font-size: 14px;
        font-weight: 300;
        margin: 20px 0;
      }

      #controlPanelContainer {
        border-top: 1px solid rgba(80, 80, 80, .3);
        position: -webkit-sticky;
        position: sticky;
        bottom: 0;
        background-image: linear-gradient(rgba(255, 255, 255, 0) 2.5%, rgba(255, 255, 255, 0.92) 55.35%);
        background-position-x: initial;
        background-position-y: initial;
        background-size: initial;
        background-repeat-x: initial;
        background-repeat-y: initial;
        background-attachment: initial;
        background-origin: initial;
        background-clip: initial;
        background-color: initial;
      }
      #controlPanel {
        display: flex;
        flex-direction: column;
      }
      #buttonContainer {
        display: flex;
        align-items: center;
        height: 50px;
        margin: 10px;
        justify-content: center;
      }
      #statusContainer {
        background-color: black;
        margin: 10px;
        padding: 0 10px;
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 50px;
      }
      #closeButton {
        margin: 14px;
        position: -webkit-sticky;
        position: sticky;
        top: 14px;
      }
      #closeButton:hover {
        background-color: white;
      }
      #closeButton:active {
        background-color: white;
      }
      #removeButton {
        background-color: #f5f5f5;
      }
      #removeButton:not([disabled]):hover {
        background-color: #fafafa;
      }
      #removeButton:active {
        background-color: #efefef;
      }
      #quantity {
        margin: 10px 30px;
        font-size: 14px;
        font-weight: 600;
      }
      #addButton {
        background-color: #f5f5f5;
      }
      #addButton:not([disabled]):hover {
        background-color: #fafafa;
      }
      #addButton:active {
        background-color: #efefef;
      }
      .space {
        width: 20%;
      }
      #status {
        font-size: 14px;
        font-weight: 700;
        color: white;
      }
      #totalCost {
        font-size: 16px;
        font-weight: 400;
        text-align: end;
        white-space: nowrap;
        margin: 0 20px;
      }

      @media all and ( min-width: 550px ) {
        #dishImage {
          height: 400px;
          top: -324px;
        }
        #overlayContent {
          width: 550px;
          height: 80%;
        }
        #controlPanel {
          flex-direction: row;
        }
        #quantity {
          margin: 10px 10px;
        }
      }

      @media all and ( min-width: 750px ) {
        #image {
          height: 300px;
          justify-content: flex-start;
        }
        #info {
          text-align: left;
        }
        #name {
          font-size: 36px;
        }
        #typeAndCost {
          justify-content: flex-start;
        }
        #menu {
          width: 550px;
        }
      }
      @media all and ( min-width: 1024px ) {
        #image {
          height: 300px;
          justify-content: flex-start;
        }
        #info {
          text-align: left;
        }
        #name {
          font-size: 36px;
        }
        #typeAndCost {
          justify-content: flex-start;
        }
        #menu {
          width: 1000px;
          margin: auto;
          max-width: 1200px;
        }
        .dishes {
          display: flex;
          justify-content: space-between;
          flex-wrap: wrap;
        }
        .dish {
          width: 48%;
          display: inline-flex;
        }
        #overlayContent {
          width: 750px;
        }
      }
      @media all and ( min-width: 1600px ) {
        #menu {
          width: 1500px;
          margin: auto;
          max-width: 2000px;
        }
        .dish {
          width: 32%;
        }
      }
    </style>
  </head>
  <body>
    <section id="application" class="application">
      <section class="header"></section>
      <section class="restaurant">
        <div id="image">
          <div id="info">
            <div id="name">&nbsp;</div>
            <div id="typeAndCost">&nbsp;</div>
            <div id="score"></div>
            <div id="address"></div>
          </div>
          <div id="closed">
          </div>
        </div>
      </section>
      <section id="menu">
        <section id="categories"></section>
        <section id="dishGroups"></section>
      </section>
      <section class="footer"></section>
    </section>
  </body>
</html>

