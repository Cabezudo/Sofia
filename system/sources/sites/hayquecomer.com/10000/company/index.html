<!DOCTYPE html>
<html profiles="all">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu digital</title>
    <link rel="stylesheet" type="text/css" href="index.css">
    <script src="variables.js"></script>
    <script src="index.js"></script>
    <script lib="core/0.1.0"></script>
    <script lib="image/0.1.0"></script>
    <script lib="simpleOverlay/0.1.0"></script>
    <script lib="linkTo/0.1.0"></script>
    <script lib="roundButton/0.1.0"></script>
    <script>
      {
        let
                overlay, info, categoriesContainerElement, categoryElementContainer = [], elementContainerSelected = 0,
                dishGroupsContainerElement, dishGroupsElement = [];
        // TODO create a library with fontFitter
        const fontFitter = (element, fontSize) => {
          const fitFontOnElement = (element, fontSize) => {
            const running = element.getAttribute('running');
            if (running === 'true') {
              return;
            }
            element.setAttribute('running', true);
            const child = element.firstChild;
            child.style.fontSize = `${fontSize}px`;
            const color = child.style.color;
            child.style.color = 'transparent';
            const checkFont = () => {
              if (element.clientHeight < child.scrollHeight && fontSize > 2) {
                fontSize--;
                child.style.fontSize = `${fontSize}px`;
                setTimeout(checkFont, 50);
              } else {
                element.setAttribute('running', false);
                child.style.color = color;
              }
            };
            checkFont();
          };
          Core.addOnResizeFunction(() => {
            fitFontOnElement(element, fontSize);
          });
          window.addEventListener('show', e => {
            fitFontOnElement(element, fontSize);
          });
          fitFontOnElement(element, fontSize);
        };
        const showDish = (event, dish) => {
          let quantity = 1;
          let total;
          const setValues = () => {
            total = quantity * dish.price.cost;
            document.getElementById('quantityOnButton').innerHTML = quantity;
            document.getElementById('totalCost').innerHTML = `${dish.price.currency} ${total}`;
          };
          let description = dish.description;
          if (description === null) {
            description = '';
          }
          const content = `
            <div id="overlayContainer">
              <div id="overlayContent">
                <div id="dishContainer">
                  <div id="dishImage">
                    <div id="closeButton" class="closeButton"></div>
                  </div>
                  <div id="dishInfo">
                    <div id="dishTitle">${dish.name}</div>
                    <div id="dishDescription">${description}</div>
                    <div id="options"></div>
                  </div>
                  <div id="controlPanelContainer">
                    <div id="controlPanel">
                      <div id="buttonContainer">
                        <div id="removeButton"></div>
                        <div id="totalCost"></div>
                        <div id="addButton"></div>
                      </div>
                      <div id="addToOrder">
                        <div id="addToOrderText">Agregar <span id="quantityOnButton"></span> a la orden</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>`;
          overlay.setContent(content);
          // TODO ocultar con ESC
          crossRoundButton({
            id: 'closeButton',
            onClick: () => {
              overlay.hide();
            }
          });
          const removeButton = removeRoundButton({
            id: 'removeButton',
            onClick: () => {
              if (quantity > 1) {
                quantity--;
                setValues();
              }
              removeButton.enable();
            }
          });
          const addButton = addRoundButton({
            id: 'addButton',
            onClick: () => {
              if (quantity < 20) {
                quantity++;
                setValues();
              }
              addButton.enable();
            }
          });
          linkTo({
            id: 'addToOrder',
            onClick: () => {
              alert(`Add ${quantity} ${dish.name} to the order.`);
              overlay.hide();
            }
          });
          overlay.show();
          const dishImage = document.getElementById('dishImage');
          if (dish.imageName === null) {
            dishImage.className = 'noDishImage';
          } else {
            dishImage.className = 'dishImage';
            image({element: dishImage, src: `/images/${dish.imageName}?resize(height=400)`});
          }
          setValues();
        };
        const setCategorySelected = () => {
          for (let i = 0; i < categoryElementContainer.length; i++) {
            // TODO Si la categoría está seleccionada no mostrar la manito
            if (elementContainerSelected === i) {
              categoryElementContainer[i].className = 'category selected';
              Core.show(dishGroupsElement[i]);
            } else {
              categoryElementContainer[i].className = 'category';
              Core.hide(dishGroupsElement[i]);
            }
          }
        };

        const createMenu = detail => {
          const menu = detail.menu;
          const categoriesHours = detail.hours.categories;
          // TODO Si la categoria es una sola no mostrar
          for (let i = 0; i < menu.length; i++) {
            const category = menu[i];
            const categoryName = category.name;
            const categoryHours = categoriesHours[categoryName];
            categoryElementContainer[i] = document.createElement('DIV');
            categoryElementContainer[i].onclick = () => {
              elementContainerSelected = i;
              setCategorySelected();
            };
            let categoryHoursText;
            if (categoryHours === null || categoriesHours.length === 0) {
              categoryHoursText = `No se sirve hoy`;
            } else {
              categoryHoursText = '';
              categoryHours.forEach(item => {
                categoryHoursText += `<div>${item.start} hs - ${item.end} hs</div>`;
              });
            }
            categoryElementContainer[i].innerHTML = `<div class="categoryName">${categoryName}</div><div class="categoryTime">${categoryHoursText}</div>`;
            categoriesContainerElement.appendChild(categoryElementContainer[i]);
            const categorySpace = document.createElement('DIV');
            categorySpace.className = 'categorySpace';
            categoriesContainerElement.appendChild(categorySpace);
            dishGroupsElement[i] = document.createElement('DIV');
            dishGroupsElement[i].className = 'dishGroups';
            dishGroupsContainerElement.appendChild(dishGroupsElement[i]);
            const dishGroups = category.dishGroups;
            dishGroups.forEach(dishGroup => {
              const dishGroupElement = document.createElement('DIV');
              dishGroupElement.innerHTML = `<div class="dishGroupTitle">${dishGroup.name}</div>`;
              dishGroupsElement[i].appendChild(dishGroupElement);
              const dishesContainerElement = document.createElement('DIV');
              dishesContainerElement.className = 'dishes';
              dishGroupElement.appendChild(dishesContainerElement);
              const dishes = dishGroup.dishes;
              dishes.forEach(dish => {
                const dishElement = document.createElement('DIV');
                dishElement.className = 'dish';
                dishesContainerElement.appendChild(dishElement);
                const dishDataElement = document.createElement('DIV');
                dishDataElement.className = 'dishData';
                dishElement.appendChild(dishDataElement);
                const dishDataNameElement = document.createElement('DIV');
                dishDataNameElement.className = 'dishName';
                dishDataNameElement.innerHTML = `<div>${dish.name}</div>`;
                dishDataElement.appendChild(dishDataNameElement);
                fontFitter(dishDataNameElement, 16);
                const dishDataDescriptionContainerElement = document.createElement('DIV');
                dishDataDescriptionContainerElement.className = 'dishDescriptionContainer';
                dishDataElement.appendChild(dishDataDescriptionContainerElement);
                const dishDataDescriptionElement = document.createElement('DIV');
                dishDataDescriptionElement.innerHTML = `${dish.description === null ? '' : dish.description}`;
                dishDataDescriptionElement.className = 'dishDescription';
                dishDataDescriptionContainerElement.appendChild(dishDataDescriptionElement);
                const dishDataPriceNameElement = document.createElement('DIV');
                dishDataPriceNameElement.className = 'dishPrice';
                dishDataPriceNameElement.innerHTML = `${dish.price.currency}${dish.price.cost}`;
                dishDataElement.appendChild(dishDataPriceNameElement);
                if (dish.imageName !== null) {
                  const dishImageElement = document.createElement('DIV');
                  dishImageElement.className = 'menuDishImage';
                  dishElement.appendChild(dishImageElement);
                  image({element: dishImageElement, src: `/images/${dish.imageName}?resize(height=180)`});
                }
                dishElement.addEventListener("click", e => {
                  showDish(e, dish);
                });
                fontFitter(dishDataDescriptionContainerElement, 16);
              });
            });
          }
          setCategorySelected();
        };
        const createGUI = () => {
          info = document.getElementById('info');
          info.addEventListener('response', event => {
            const detail = event.detail;
            const businessHours = detail.hours.businessHours;
            const restaurant = detail.restaurant;
            const setData = (id, html) => {
              document.getElementById(id).innerHTML = html;
            };
            const isOpen = detail.hours.isOpen;
            let restaurantImage;
            if (isOpen) {
              restaurantImage = restaurant.imageName;
            } else {
              restaurantImage = `${restaurant.imageName}?brightness(model=hsb,value=30)`;
              let closedText = '';
              let schedule = '';
              if (!businessHours.today.isOpen) {
                if (businessHours.closedUntil !== null) {
                  schedule = `Abre hasta el ${businessHours.closedUntil.name.toLowerCase()} ${businessHours.closedUntil.openAt} hs`;
                }
                if (businessHours.tomorrow.openAt !== null) {
                  schedule = `Abre mañana ${businessHours.tomorrow.name.toLowerCase()} ${businessHours.tomorrow.openAt} hs`;
                }
                if (businessHours.today.openAt !== null) {
                  schedule = `Abre hoy ${businessHours.today.openAt} hs`;
                }
                closedText = `<div class="title">Cerrado</div><div class="schedule">${schedule}</div>`;
                const closed = document.getElementById('closed');
                closed.innerHTML = closedText;
              }
            }
            document.getElementById('image').style.backgroundImage = `url('/images/${restaurantImage}')`;
            setData('name', restaurant.name);
            let typeAndCost = '';
            if (restaurant.type) {
              typeAndCost = `<div>${restaurant.type.name}</div>`;
            }
            switch (restaurant.priceRange) {
              case 1:
                typeAndCost += '&nbsp;&middot;&nbsp;<div class="cost">$</div>';
                break;
              case 2:
                typeAndCost += '&nbsp;&middot;&nbsp;<div class="cost">$$</div>';
                break;
              case 3:
                typeAndCost += '&nbsp;&middot;&nbsp;<div class="cost">$$$</div>';
            }
            setData('typeAndCost', typeAndCost);
            let score = '';
            if (restaurant.score) {
              score = restaurant.score;
              if (restaurant.numberOfVotes) {
                score += ` (${restaurant.numberOfVotes})`;
              }
              setData('score', score);
            }
            setData('name', restaurant.name);
            createMenu(detail);
          });
          categoriesContainerElement = document.getElementById('categories');
          dishGroupsContainerElement = document.getElementById('dishGroups');
          overlay = simpleOverlay({id: 'overlay', scrollElement: document.body});
        };
        const loadData = () => {
          const timeZoneOffset = (new Date()).getTimezoneOffset();
          Core.sendGet(`/api/v1/restaurants/${variables.company.host}/menu?timeZoneOffset=${timeZoneOffset}`, info);
        };
        Core.addOnloadFunction(createGUI);
        Core.addOnloadFunction(loadData);
      }
    </script>
  </head>
  <body>
    <section id="application" class="application">
      <section class="header"></section>
      <section class="restaurant">
        <div id="image">
          <div id="info">
            <div id="name">&nbsp;</div>
            <div id="typeAndCost">&nbsp;</div>
            <div id="score"></div>
            <div id="address"></div>
          </div>
          <div id="closed">
          </div>
        </div>
      </section>
      <section id="menu">
        <section id="categories"></section>
        <section id="dishGroups"></section>
      </section>
      <section class="footer"></section>
    </section>
  </body>
</html>

